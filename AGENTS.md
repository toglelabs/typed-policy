# Typed Policy - Project Context

This document provides context for AI assistants working on the Typed Policy project.

## Project Overview

**Typed Policy** is a Policy-as-Code library for TypeScript that allows you to:
1. Define authorization policies with full type safety
2. Evaluate them as booleans on the frontend
3. Compile them to SQL for backend database queries

**Key Innovation**: Single policy definition works in both environments with compile-time guarantees.

## Technology Stack

- **Language**: TypeScript 5.3+
- **Package Manager**: pnpm 8+
- **Build Tool**: tsup (ESM + TypeScript declarations)
- **Testing**: Vitest with v8 coverage provider
- **Linting/Formatting**: Biome
- **Monorepo**: pnpm workspaces

## Project Structure

```
typed-policy/
├── packages/
│   ├── core/          # AST types, DSL operators (zero deps)
│   ├── eval/          # Frontend evaluator
│   └── drizzle/       # SQL compiler for Drizzle ORM
├── examples/
│   ├── react/         # Interactive React demo
│   └── hono-drizzle/  # Full-stack API example
└── [config files]
```

## Core Concepts

### Type-Safe Paths
The library uses recursive template literal types to validate paths at compile time:

```typescript
type Path<T> = T extends Primitive ? never : {
  [K in keyof T & string]: T[K] extends Primitive 
    ? K 
    : K | `${K}.${Path<T[K]>}`
}[keyof T & string]
```

This ensures that `eq("user.rol", "admin")` produces a compile-time error (typo in "rol").

### AST Design
Policies compile to a typed AST that can be executed in different environments:

```typescript
type Expr<T> =
  | { kind: "eq"; left: Path<T>; right: Path<T> | Value }
  | { kind: "and"; rules: Expr<T>[] }
  | { kind: "or"; rules: Expr<T>[] }
```

### Zero Runtime Magic
- No decorators
- No proxies
- No schema inspection
- Pure TypeScript type-level programming

## Common Tasks

### Adding a New Operator

1. Add to `packages/core/src/ast.ts`:
```typescript
| { kind: "neq"; left: Path<T>; right: Path<T> | Value }
```

2. Add to `packages/core/src/operators.ts`:
```typescript
export function neq<T, L extends Path<T>>(left: L, right: Path<T> | PathValue<T, L>): Expr<T>
```

3. Add evaluation in `packages/eval/src/evaluate.ts`:
```typescript
case "neq": return leftValue !== rightValue
```

4. Add compilation in `packages/drizzle/src/compile.ts`:
```typescript
case "neq": return drizzleNe(column, value)
```

5. Add tests in `packages/eval/src/evaluate.test.ts`

### Running Tests

```bash
pnpm test              # Run all tests
pnpm test --coverage   # Run with coverage report
pnpm test packages/eval  # Run specific package tests
```

### Code Quality

```bash
pnpm check            # Run Biome checks
pnpm format           # Format code
pnpm check:fix        # Fix auto-fixable issues
```

### Building

```bash
pnpm build            # Build all packages
pnpm -r build         # Build recursively
```

## Conventions

### File Naming
- Source files: `*.ts`
- Test files: `*.test.ts` (co-located with source)
- Types: `*.d.ts` (auto-generated by tsup)

### Import Style
- Always use `.js` extension in imports (for ESM compatibility)
- Use `import type` for type-only imports
- Prefer named exports

### Code Style (Biome)
- 2-space indentation
- Double quotes
- Semicolons required
- Trailing commas (all)
- 100 character line width

### Testing Philosophy
- Test behavior, not implementation
- Use descriptive test names
- Test edge cases (empty arrays, nulls, etc.)
- Maintain 80% coverage minimum

## Git Workflow

### Branch Naming
- `feat/` - New features
- `fix/` - Bug fixes  
- `docs/` - Documentation
- `refactor/` - Code refactoring
- `test/` - Test changes

### Commit Format
Follow Conventional Commits:
```
feat(core): add neq operator
fix(eval): handle null values
docs(readme): update installation guide
```

## Key Files to Know

- `packages/core/src/paths.ts` - Path type utilities
- `packages/core/src/ast.ts` - AST definition
- `packages/core/src/operators.ts` - DSL operators
- `packages/eval/src/evaluate.ts` - Runtime evaluation
- `packages/drizzle/src/compile.ts` - SQL compilation
- `biome.json` - Code style configuration
- `vitest.config.ts` - Test configuration

## Publishing

Releases are automated via GitHub Actions:
1. Create a git tag: `git tag -a v0.1.0 -m "Release v0.1.0"`
2. Push tag: `git push origin v0.1.0`
3. CI will run tests, build, and publish to npm

**Required Secret**: `NPM_TOKEN` must be set in GitHub repository settings.

## Troubleshooting

### Type errors after changes
Run `pnpm typecheck` to catch TypeScript errors across all packages.

### Tests failing
Check if you need to rebuild: `pnpm build` before `pnpm test`.

### Coverage not meeting threshold
Run `pnpm test --coverage` to see detailed coverage report.

## External Resources

- **Repository**: https://github.com/toglelabs/typed-policy
- **npm**: https://www.npmjs.com/org/typed-policy
- **Drizzle ORM**: https://orm.drizzle.team/
- **Biome**: https://biomejs.dev/
- **Vitest**: https://vitest.dev/

---

*Last updated: 2024-02-01*
*Maintained by: Ihsan VP <m.ihsan.vp@gmail.com>*
